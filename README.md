# BN inference with DDs

**TODO:**
- Verify WMC with no constraint on all networks.


## Dependencies


* Dependencies of [Sylvan](https://github.com/trolando/sylvan).
* [Graphviz](https://graphviz.org/) for visualization of BNs
* Python + packages in [requirements.txt](requirements.txt)
```bash
# install Sylvan dependencies
sudo apt install cmake cmake-data build-essential
sudo apt install libgmp-dev

# install Graphviz (optional)
sudo apt install graphviz graphviz-dev

# create a virtual environment (optional)
python -m venv .venv
source .venv/bin/activate

# install dependencies TODO: update requirements.txt inc. version numbers
pip install -r requirements.txt
```

Some notes on version numbers of packages:
```bash
# 'pymc3' requires specific versions of scipy and numpy:
pymc3 3.11.5 requires numpy<1.22.2,>=1.15.0     (e.g. numpy==1.21.6)
pymc3 3.11.5 requires scipy<1.8.0,>=1.7.3       (scipy==1.7.3)
# it should be possible to install these with (do scipy first)
pip install --force-reinstall -v scipy==1.7.3
pip install --force-reinstall -v numpy==1.21.6

# However, 'dowhy' has dependencies which are incompatible:
dowhy 0.9.1 requires numpy<2.0.0,>=1.23.1
dowhy 0.9.1 requires scipy<2.0.0,>=1.8.1
# (but we can try to run it anyway)
```

## Installation (Linux)

1. Clone the repo (including submodules)
2. Compilation has been tested with GCC/G++ 10. It might work with different version, but gcc/g++ version can be set with the following (though paths could be different).
```shell
$ export CC=/usr/bin/gcc-10
$ export CXX=/usr/bin/g++-10
```

3. To compile everything, run
```shell
$ ./compile_sources.sh
```

## Run the code
To generate a Bayesian network in data `.csv` format and settings `.json`, run
```shell
$ python scripts/generate_bn.py distribution experiment
```

To discretize a Bayesian network to `.xmlbif` format and settings `.json`, run
```shell
$ python scripts/discretize_bn.py model discretization_method bins --target_column
```

for example: 
```shell
$ python scripts/generate_bn.py lg 1
$ python scripts/discretize_bn.py lg5000 disc EB10
```

To turn a Bayesian network in `.xmlbif` format into a CNF formula, run
```shell
$ python scripts/bn_to_cnf.py models/model_name.xmlbif
```

To run run inference (**TODO:** add cl options to run specific queries? We can also do the entire optimization in C++.)
```shell
$ ./dd_inference/build/analyze_bn models/model_name
```

To draw the paretofront: run the following command
```shell
$ python scripts/draw_pareto_front.py lg rmse
```

To generate a bash script which runs all experiments:
```shell
$ python scripts/generate_experiments.py <distribution> <experiment>
```
which generates a bash file `exp_<exp-id>` (where <exp-id> is some number) which can then be run with
```shell
$ bash experiments/exp_<exp-id>
```

### Ace WMC experiments

There is a bug in pgmpy's NETWriter (NET format is needed for Ace). A fixed verion of `NET.py` is included in the `pgmpy_netwriter_fix/` folder. There is also a script which should automatically patch this if `pgmpy` is installed in a virtual environment `.venv` at the root of the repository:
```shell
$ bash pgmpy_netwriter_fix/apply_fix.sh
```

To run Ace from command line:
```shell
$ python include/Ace/ace.py --network <model.xmlbif|model.net> --overwrite
```
* `--overwrite` recompiles the BN to the format Ace uses, even if it has already previously been compiled.
* this produces an outputfile `model_aceinfo.json` similar to `model_ddinfo.json`

A bash script with the entire experimental pipeline for the Ace experiments can be generated by adding the `--ace` argument to the `generate_experiments.py` script:
```shell
python scripts/generate_experiments.py <distribution> <experiment> --ace
```
